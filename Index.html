<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Health Wellness Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
  :root {
    --bg:#fff; --text:#0f172a; --muted:#51607a;
    --card:#fff; --border:#e5eaf1; --ring:#2a70ff33;
  }
  *{box-sizing:border-box;}
  body{margin:0;padding:28px;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
  h1{font-size:28px;margin:0;font-weight:700;}
  .updated{color:var(--muted);font-size:13px;margin-top:4px;margin-bottom:18px;}
  .tabs{display:flex;gap:10px;margin-bottom:20px;}
  .tab-button{padding:8px 14px;border:1px solid #d1d5db;border-radius:8px;background:#f9fafb;cursor:pointer;transition:background .2s;}
  .tab-button:hover{background:#eef2ff;}
  .tab-button.active{background:#2a70ff;color:#fff;border-color:#2a70ff;}
  .tab-content{display:none;}
  .tab-content.active{display:block;}
  .grid{display:grid;grid-template-columns:1.2fr 2fr;gap:18px;}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;}
  .kpis2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px;}
  .kpi{border:1px solid var(--border);border-radius:12px;padding:14px;}
  .kpi h3{margin:0;font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.5px;text-transform:uppercase;}
  .kpi .val{margin-top:6px;font-size:22px;font-weight:700;}
  .legend{font-size:13px;color:var(--muted);margin-bottom:10px;}
  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 14px;}
  select,.multi{background:#fff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:140px;}
  select:focus{outline:none;box-shadow:0 0 0 6px var(--ring);}
  .multi{min-width:260px;max-width:420px;}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f6f8fb;border:1px solid var(--border);color:var(--muted);font-size:12px;}
  .section-title{font-size:16px;font-weight:700;margin:8px 0 8px;}
  iframe{width:100%;height:80vh;border:none;}
  @media(max-width:1060px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<h1>Health Wellness Dashboard</h1>
<div id="loadStatus" style="color:#51607a;font-size:14px;margin-bottom:10px;">Loading data...</div>
<div class="updated">Data automatically loaded from Google Sheets</div>

<div class="tabs">
  <button class="tab-button active" onclick="openTab('current')">Current Data</button>
  <button class="tab-button" onclick="openTab('active')">Active Partners</button>
  <button class="tab-button" onclick="openTab('pending')">Pending Inquiries</button>
</div>

<div class="tab-content active" id="current">
  <div class="grid">
    <div>
      <div class="kpis">
        <div class="kpi"><h3>Total Members</h3><div class="val" id="kpiTotal">0</div></div>
        <div class="kpi"><h3>Total BLACK CARD MEMBER</h3><div class="val" id="kpiBC">0</div></div>
        <div class="kpi"><h3>Total 10NR</h3><div class="val" id="kpi10NR">0</div></div>
      </div>
      <div class="kpis2">
        <div class="kpi"><h3>CORPFM15</h3><div class="val" id="kpiCORPFM15">US: 0 | CAN: 0</div></div>
        <div class="kpi"><h3>CORPFMBC</h3><div class="val" id="kpiCORPFMBC">US: 0 | CAN: 0</div></div>
      </div>
      <div class="card">
        <div class="legend">Region Breakdown (CAN vs US)</div>
        <div id="regionChart"></div>
      </div>
    </div>
    <div class="card">
      <div class="legend">Monthly Impact — total signups per month (all promotions, both regions)</div>
      <div class="toolbar" style="justify-content:flex-end">
        <label class="pill">Time Range
          <select id="timeRange">
            <option value="all" selected>All Time</option>
            <option value="ytd">Year-to-Date</option>
            <option value="month">Most Recent Month</option>
          </select>
        </label>
      </div>
      <div id="impactChart"></div>
    </div>
  </div>

  <div class="card" style="margin-top:18px;">
    <div class="section-title">Promotions — Signups Over Time</div>
    <div class="toolbar">
      <label class="pill">Promotion Name (multi-select)
        <select class="multi" id="promos" multiple size="6"></select>
      </label>
      <label class="pill">View
        <select id="promoView">
          <option selected value="all">All</option>
          <option value="monthly">Monthly</option>
        </select>
      </label>
      <span class="pill"><span id="selCount">All promotions</span></span>
    </div>
    <div id="promoChart"></div>
  </div>
</div>

<div class="tab-content" id="active">
  <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSkf0CtRTvB6WLSq7NrnCJ13Yy7TKFehNLU4p_IMj7zz_eTJAxw6-fw-27M9UWNDurEWNOZy3vM6l16/pubhtml?gid=1889691124&single=true"></iframe>
</div>
<div class="tab-content" id="pending">
  <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSkf0CtRTvB6WLSq7NrnCJ13Yy7TKFehNLU4p_IMj7zz_eTJAxw6-fw-27M9UWNDurEWNOZy3vM6l16/pubhtml?gid=279243253&single=true"></iframe>
</div>

<script>
function openTab(tabName){
  document.querySelectorAll(".tab-content").forEach(el=>el.classList.remove("active"));
  document.querySelectorAll(".tab-button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById(tabName).classList.add("active");
  document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add("active");
}
function fmtNum(n){return Number(n||0).toLocaleString();}
function normalizeKeys(rec){const f={};for(const k in rec){f[k.trim().toLowerCase()]=rec[k];}return f;}
function toMonthly(s){const d=new Date(s+"T00:00:00");if(isNaN(d))return"Unknown";return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");}

function filterByRange(data,range="all"){
  const now=new Date(),yr=now.getFullYear(),mo=now.getMonth();
  return data.filter(r=>{
    const d=new Date((r["created date"]||"").trim());
    if(isNaN(d))return false;
    if(range==="ytd")return d.getFullYear()===yr;
    if(range==="month")return d.getFullYear()===yr && d.getMonth()===mo;
    return true;
  });
}

function renderKPIs(data){
  document.getElementById("kpiTotal").textContent=fmtNum(data.length);
  document.getElementById("kpiBC").textContent=fmtNum(data.filter(r=>(r["membership type"]||"").toUpperCase().includes("BLACK CARD")).length);
  document.getElementById("kpi10NR").textContent=fmtNum(data.filter(r=>(r["membership type"]||"").toUpperCase().includes("10NR")).length);
  const c15={US:0,CAN:0},cBC={US:0,CAN:0};
  data.forEach(r=>{
    const promo=(r["promotion name"]||"").toUpperCase(),reg=(r["region"]||"").toUpperCase();
    if(promo.includes("CORPFM15"))c15[reg]=(c15[reg]||0)+1;
    if(promo.includes("CORPFMBC"))cBC[reg]=(cBC[reg]||0)+1;
  });
  document.getElementById("kpiCORPFM15").textContent=`US: ${fmtNum(c15.US)} | CAN: ${fmtNum(c15.CAN)}`;
  document.getElementById("kpiCORPFMBC").textContent=`US: ${fmtNum(cBC.US)} | CAN: ${fmtNum(cBC.CAN)}`;
}

function renderRegion(data){
  const c={US:0,CAN:0};
  data.forEach(r=>{const reg=(r["region"]||"").toUpperCase();if(c[reg]!=null)c[reg]++;});
  Plotly.newPlot("regionChart",
    [{x:Object.keys(c),y:Object.values(c),type:"bar"}],
    {margin:{t:20,l:50,r:10,b:40},yaxis:{title:"Signups"}},{displayModeBar:false});
}

function renderImpact(data){
  const m={};
  data.forEach(r=>{
    const d=new Date((r["created date"]||"").trim());
    if(!isNaN(d)){
      const key=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
      m[key]=(m[key]||0)+1;
    }
  });
  const keys=Object.keys(m).sort();
  const vals=keys.map(k=>m[k]);
  const labels=keys.map(k=>{
    const [y,mm]=k.split("-");
    const d=new Date(y,parseInt(mm)-1);
    return d.toLocaleString("default",{month:"short",year:"numeric"});
  });
  Plotly.newPlot("impactChart",
    [{x:labels,y:vals,type:"scatter",mode:"lines+markers"}],
    {margin:{t:20,l:50,r:10,b:40},yaxis:{title:"Signups"},xaxis:{title:"Month"}},
    {displayModeBar:false});
}

async function loadData(){
  const status=document.getElementById("loadStatus");
  try{
    const sheetUrl="https://corsproxy.io/?"+encodeURIComponent("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8iruNQ-H8vQvlNMSNXiUtOoxI1b8lEyL7YMBOifM2os3qyRTdmQ2_1V2oKk4vMlQifynBfxrN-u-F/pub?output=csv");
    const res=await fetch(sheetUrl);const text=await res.text();
    const rows=text.trim().split("\n").map(r=>r.split(","));const headers=rows[0];
    const data=rows.slice(1).map(r=>{const o={};headers.forEach((h,i)=>o[h.trim()]=r[i]);return normalizeKeys(o);});

    renderKPIs(data);renderRegion(data);renderImpact(data);
    const select=document.getElementById("timeRange");
    select.addEventListener("change",e=>{
      const range=e.target.value;
      const filtered=filterByRange(data,range);
      renderKPIs(filtered);
      renderRegion(filtered);
      renderImpact(filtered);
    });

    status.textContent="✅ Data loaded successfully!";status.style.color="green";
  }catch(err){
    console.error("Error loading data:",err);
    status.textContent="⚠️ Failed to load data. Check your connection or Google Sheet permissions.";
    status.style.color="red";
  }
}
window.addEventListener("DOMContentLoaded",loadData);
</script>
</body>
</html>
