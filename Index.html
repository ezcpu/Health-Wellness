<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Health Wellness Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
  :root {
    --bg: #ffffff;
    --text: #0f172a;
    --muted: #51607a;
    --card: #ffffff;
    --border: #e5eaf1;
    --ring: #2a70ff33;
  }
  body.dark {
    --bg: #0f172a;
    --text: #f1f5f9;
    --muted: #a3b0c3;
    --card: #1e293b;
    --border: #334155;
    --ring: #60a5fa33;
  }
  *{box-sizing:border-box;transition:background-color 0.3s,color 0.3s,border-color 0.3s;}
  body{margin:0;padding:28px;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
  h1{font-size:28px;margin:0;font-weight:700;}
  .updated{color:var(--muted);font-size:13px;margin-top:4px;margin-bottom:18px;}
  .tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
  .tab-button{padding:8px 14px;border:1px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer;transition:all .2s;}
  .tab-button:hover{background:#eef2ff;}
  body.dark .tab-button:hover{background:#1e293b;}
  .tab-button.active{background:#2a70ff;color:#fff;border-color:#2a70ff;}
  .tab-content{display:none;}
  .tab-content.active{display:block;}
  .grid{display:grid;grid-template-columns:1.2fr 2fr;gap:18px;}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;}
  .kpis2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px;}
  .kpi{border:1px solid var(--border);border-radius:12px;padding:14px;}
  .kpi h3{margin:0;font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.5px;text-transform:uppercase;}
  .kpi .val{margin-top:6px;font-size:22px;font-weight:700;}
  .legend{font-size:13px;color:var(--muted);margin-bottom:10px;}
  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 14px;}
  select,.multi{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:140px;}
  select:focus{outline:none;box-shadow:0 0 0 6px var(--ring);}
  .multi{min-width:260px;max-width:420px;}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--bg);border:1px solid var(--border);color:var(--muted);font-size:12px;}
  .section-title{font-size:16px;font-weight:700;margin:8px 0 8px;}
  iframe{width:100%;height:80vh;border:none;}
  .changelog{line-height:1.6;font-size:14px;color:var(--text);}
  .changelog h2{font-size:18px;margin-top:0;margin-bottom:8px;}
  .theme-toggle{margin-left:auto;padding:6px 12px;font-size:12px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;color:var(--text);}
  @media(max-width:1060px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<h1 style="display:flex;align-items:center;justify-content:space-between;">
  Health Wellness Dashboard
  <button id="themeToggle" class="theme-toggle">🌙 Dark Mode</button>
</h1>
<div id="loadStatus" style="color:var(--muted);font-size:14px;margin-bottom:10px;">Loading data...</div>
<div class="updated">Data automatically loaded from Google Sheets</div>

<div class="tabs">
  <button class="tab-button active" onclick="openTab('current')">Current Data</button>
  <button class="tab-button" onclick="openTab('active')">Active Partners</button>
  <button class="tab-button" onclick="openTab('pending')">Pending Inquiries</button>
  <button class="tab-button" onclick="openTab('changelog')">Changelog</button>
</div>

<!-- CURRENT DATA -->
<div class="tab-content active" id="current">
  <div class="grid">
    <div>
      <div class="kpis">
        <div class="kpi"><h3>Total Members</h3><div class="val" id="kpiTotal">0</div></div>
        <div class="kpi"><h3>Total BLACK CARD MEMBER</h3><div class="val" id="kpiBC">0</div></div>
        <div class="kpi"><h3>Total 10NR</h3><div class="val" id="kpi10NR">0</div></div>
      </div>
      <div class="kpis2">
        <div class="kpi"><h3>CORPFM15</h3><div class="val" id="kpiCORPFM15">US: 0 | CAN: 0</div></div>
        <div class="kpi"><h3>CORPFMBC</h3><div class="val" id="kpiCORPFMBC">US: 0 | CAN: 0</div></div>
      </div>
      <div class="card">
        <div class="legend">Region Breakdown (CAN vs US)</div>
        <div id="regionChart"></div>
      </div>
    </div>

    <div class="card">
      <div class="legend">Monthly Impact — total signups per month</div>
      <div class="toolbar" style="justify-content:flex-end">
        <label class="pill">Select Month
          <select id="monthSelect">
            <option value="all" selected>All Months</option>
          </select>
        </label>
      </div>
      <div id="impactChart"></div>
    </div>
  </div>

  <div class="card" style="margin-top:18px;">
    <div class="section-title">Promotions — Signups Over Time</div>
    <div class="toolbar">
      <label class="pill">Promotion Name (multi-select)
        <select class="multi" id="promos" multiple size="6"></select>
      </label>
      <label class="pill">View
        <select id="promoView">
          <option selected value="all">All</option>
          <option value="monthly">Monthly</option>
        </select>
      </label>
    </div>
    <div id="promoChart"></div>
  </div>
</div>

<!-- OTHER TABS -->
<div class="tab-content" id="active">
  <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSkf0CtRTvB6WLSq7NrnCJ13Yy7TKFehNLU4p_IMj7zz_eTJAxw6-fw-27M9UWNDurEWNOZy3vM6l16/pubhtml?gid=1889691124&single=true"></iframe>
</div>
<div class="tab-content" id="pending">
  <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSkf0CtRTvB6WLSq7NrnCJ13Yy7TKFehNLU4p_IMj7zz_eTJAxw6-fw-27M9UWNDurEWNOZy3vM6l16/pubhtml?gid=279243253&single=true"></iframe>
</div>
<div class="tab-content" id="changelog">
  <div class="card changelog">
    <h2>Changelog</h2>
    <ul>
      <li><strong>10.31.2025:</strong> Added Month selector + dark/light mode toggle 🌙</li>
      <li><strong>10.31.2025:</strong> Switched Monthly Impact to bar chart for clarity.</li>
      <li><strong>10.31.2025:</strong> linked CSV file for on the fly update of Data.</li>
    </ul>
  </div>
</div>

<script>
// ----- Tabs & Theme Toggle -----
function openTab(tabName){
  document.querySelectorAll(".tab-content").forEach(el=>el.classList.remove("active"));
  document.querySelectorAll(".tab-button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById(tabName).classList.add("active");
  document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add("active");
}

document.getElementById("themeToggle").addEventListener("click",()=>{
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  document.getElementById("themeToggle").textContent=isDark?"☀️ Light Mode":"🌙 Dark Mode";
  updateChartThemes(isDark);
});

// ----- Utility -----
function fmtNum(n){return Number(n||0).toLocaleString();}
function normalizeKeys(rec){const f={};for(const k in rec){f[k.trim().toLowerCase()]=rec[k];}return f;}
function toMonthly(s){const d=new Date(s+"T00:00:00");if(isNaN(d))return"Unknown";return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");}
function filterByMonth(data,selectedMonth="all"){
  if(selectedMonth==="all")return data;
  return data.filter(r=>{
    const d=new Date((r["created date"]||"").trim());
    if(isNaN(d))return false;
    const key=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    return key===selectedMonth;
  });
}

// ----- KPI + Charts -----
function renderKPIs(data){
  document.getElementById("kpiTotal").textContent=fmtNum(data.length);
  document.getElementById("kpiBC").textContent=fmtNum(data.filter(r=>(r["membership type"]||"").toUpperCase().includes("BLACK CARD")).length);
  document.getElementById("kpi10NR").textContent=fmtNum(data.filter(r=>(r["membership type"]||"").toUpperCase().includes("10NR")).length);
  const c15={US:0,CAN:0},cBC={US:0,CAN:0};
  data.forEach(r=>{
    const promo=(r["promotion name"]||"").toUpperCase(),reg=(r["region"]||"").toUpperCase();
    if(promo.includes("CORPFM15"))c15[reg]=(c15[reg]||0)+1;
    if(promo.includes("CORPFMBC"))cBC[reg]=(cBC[reg]||0)+1;
  });
  document.getElementById("kpiCORPFM15").textContent=`US: ${fmtNum(c15.US)} | CAN: ${fmtNum(c15.CAN)}`;
  document.getElementById("kpiCORPFMBC").textContent=`US: ${fmtNum(cBC.US)} | CAN: ${fmtNum(cBC.CAN)}`;
}

function renderRegion(data){
  const c={US:0,CAN:0};
  data.forEach(r=>{const reg=(r["region"]||"").toUpperCase();if(c[reg]!=null)c[reg]++;});
  Plotly.newPlot("regionChart",
    [{x:Object.keys(c),y:Object.values(c),type:"bar",marker:{color:getBarColor()}}],
    getChartLayout("Signups","Region"),{displayModeBar:false});
}

function renderImpact(data){
  const m={};
  data.forEach(r=>{
    const d=new Date((r["created date"]||"").trim());
    if(!isNaN(d)){
      const key=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
      m[key]=(m[key]||0)+1;
    }
  });
  const keys=Object.keys(m).sort();
  const vals=keys.map(k=>m[k]);
  const labels=keys.map(k=>{
    const [y,mm]=k.split("-");
    const d=new Date(y,parseInt(mm)-1);
    return d.toLocaleString("default",{month:"short",year:"numeric"});
  });
  Plotly.newPlot("impactChart",
    [{x:labels,y:vals,type:"bar",marker:{color:getBarColor()}}],
    getChartLayout("Signups","Month"),{displayModeBar:false});
}

function renderPromoSection(data) {
  const promos = [...new Set(
    data.map(r => (r["promotion name"] || "").trim()).filter(x => x !== "")
  )].sort();

  const sel = document.getElementById("promos");
  sel.innerHTML = "";
  promos.forEach(p => {
    const o = document.createElement("option");
    o.value = p;
    o.textContent = p;
    sel.appendChild(o);
  });

  // Auto-select all
  if (promos.length > 0) Array.from(sel.options).forEach(o => o.selected = true);
  sel.size = Math.min(promos.length, 10);

  drawPromos();

  function drawPromos() {
    const mode = document.getElementById("promoView").value;
    const selected = Array.from(sel.selectedOptions).map(o => o.value);
    const used = selected.length ? selected : promos;
    const filtered = data.filter(r => used.includes((r["promotion name"] || "").trim()));

    // Parse month keys from created date (support slashes, dashes, timestamps)
    const months = [...new Set(filtered.map(r => {
      const raw = (r["created date"] || "").trim();
      const d = new Date(raw);
      if (isNaN(d)) return null;
      return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
    }).filter(Boolean))].sort();

    if (months.length === 0) {
      document.getElementById("promoChart").innerHTML =
        "<p style='text-align:center;color:var(--muted);margin-top:20px;'>No signup data found for selected promotions.</p>";
      return;
    }

    // Build grouped bars per promotion
    const traces = [];
    used.forEach(promo => {
      const series = months.map(m => {
        return filtered.filter(r => {
          const raw = (r["created date"] || "").trim();
          const d = new Date(raw);
          if (isNaN(d)) return false;
          const key = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
          return key === m && (r["promotion name"] || "").trim() === promo;
        }).length;
      });
      if (series.some(v => v > 0)) {
        const labels = months.map(m => {
          const [y, mm] = m.split("-");
          const d = new Date(y, parseInt(mm) - 1);
          return d.toLocaleString("default", { month: "short", year: "numeric" });
        });
        traces.push({
          x: labels,
          y: series,
          name: promo,
          type: "bar",
          marker: { color: getBarColor() }
        });
      }
    });

    if (traces.length === 0) {
      document.getElementById("promoChart").innerHTML =
        "<p style='text-align:center;color:var(--muted);margin-top:20px;'>No signups for selected promotions.</p>";
      return;
    }

    Plotly.newPlot(
      "promoChart",
      traces,
      { ...getChartLayout("Signups", "Month"), barmode: "group", legend: { orientation: "h" } },
      { displayModeBar: false }
    );
  }

  document.getElementById("promoView").onchange = drawPromos;
  sel.onchange = drawPromos;
}


// ----- Helpers for chart theming -----
function getBarColor() {
  return document.body.classList.contains("dark") ? "#60a5fa" : "#2a70ff";
}

function getChartLayout(yTitle, xTitle) {
  const dark = document.body.classList.contains("dark");
  return {
    margin: { t: 20, l: 50, r: 10, b: 40 },
    yaxis: {
      title: yTitle,
      color: dark ? "#f1f5f9" : "#0f172a",
      gridcolor: dark ? "#334155" : "#e5eaf1",
    },
    xaxis: {
      title: xTitle,
      color: dark ? "#f1f5f9" : "#0f172a",
      gridcolor: dark ? "#334155" : "#e5eaf1",
    },
    paper_bgcolor: dark ? "#0f172a" : "#ffffff",
    plot_bgcolor: dark ? "#0f172a" : "#ffffff",
    font: { color: dark ? "#f1f5f9" : "#0f172a" },
    showlegend: true,
  };
}

function updateChartThemes(isDark) {
  // Re-render all existing charts with new theme
  const update = {
    "paper_bgcolor": isDark ? "#0f172a" : "#ffffff",
    "plot_bgcolor": isDark ? "#0f172a" : "#ffffff",
    "font.color": isDark ? "#f1f5f9" : "#0f172a",
    "xaxis.color": isDark ? "#f1f5f9" : "#0f172a",
    "yaxis.color": isDark ? "#f1f5f9" : "#0f172a",
    "xaxis.gridcolor": isDark ? "#334155" : "#e5eaf1",
    "yaxis.gridcolor": isDark ? "#334155" : "#e5eaf1"
  };

  // Safely update all charts if they exist
  ["regionChart", "impactChart", "promoChart"].forEach(id => {
    if (document.getElementById(id)) {
      Plotly.relayout(id, update);
    }
  });
}

// ----- Data Loading -----
async function loadData(){
  const status=document.getElementById("loadStatus");
  try{
    const sheetUrl="https://corsproxy.io/?"+encodeURIComponent("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8iruNQ-H8vQvlNMSNXiUtOoxI1b8lEyL7YMBOifM2os3qyRTdmQ2_1V2oKk4vMlQifynBfxrN-u-F/pub?output=csv");
    const res=await fetch(sheetUrl);
    const text=await res.text();
    const rows=text.trim().split("\n").map(r=>r.split(","));
    const headers=rows[0];
    const data=rows.slice(1).map(r=>{const o={};headers.forEach((h,i)=>o[h.trim()]=r[i]);return normalizeKeys(o);});

    renderKPIs(data);renderRegion(data);renderImpact(data);renderPromoSection(data);

    const monthSelect=document.getElementById("monthSelect");
    const months=[...new Set(data.map(r=>{
      const d=new Date((r["created date"]||"").trim());
      if(isNaN(d))return null;
      return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    }).filter(Boolean))].sort();
    months.forEach(m=>{
      const [y,mm]=m.split("-");
      const d=new Date(y,parseInt(mm)-1);
      const opt=document.createElement("option");
      opt.value=m;opt.textContent=d.toLocaleString("default",{month:"long",year:"numeric"});
      monthSelect.appendChild(opt);
    });
    monthSelect.addEventListener("change",e=>{
      const filtered=filterByMonth(data,e.target.value);
      renderKPIs(filtered);renderRegion(filtered);renderImpact(filtered);
    });

    status.textContent="✅ Data loaded successfully!";status.style.color="green";
  }catch(err){
    console.error("Error loading data:",err);
    status.textContent="⚠️ Failed to load data. Check your connection or Google Sheet permissions.";
    status.style.color="red";
  }
}
window.addEventListener("DOMContentLoaded",loadData);
</script>
</body>
</html>



