<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Health & Wellness Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<style>
:root {
  --bg:#ffffff; --text:#0f172a; --muted:#51607a; --card:#ffffff; --border:#e5eaf1;
  --us:#2563eb; --can:#9333ea; --accent:#10b981; --warn:#f59e0b;
  --shadow:0 1px 2px rgba(15,23,42,.06),0 8px 24px rgba(15,23,42,.06);
}
body.dark {
  --bg:#0f172a; --text:#f1f5f9; --muted:#a3b0c3; --card:#0b1220; --border:#1f2a3a;
  --shadow:0 1px 2px rgba(0,0,0,.35),0 10px 28px rgba(0,0,0,.35);
}
*{box-sizing:border-box;transition:background-color .25s,color .25s,border-color .25s;}
html,body{height:100%}
body{margin:0;padding:24px;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
h1{font-size:28px;margin:0 0 6px 0;font-weight:700;letter-spacing:.2px}
.small{font-size:13px;color:var(--muted);margin-bottom:14px;}
.tabs{display:flex;gap:10px;margin:14px 0 18px;flex-wrap:wrap;}
.tab-button{padding:8px 14px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;box-shadow:var(--shadow);}
.tab-button:hover{border-color:#c7d2e2}
.tab-button.active{background:linear-gradient(180deg,var(--us),#1d4ed8);color:#fff;border-color:transparent;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:18px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px;}
.kpi{border:1px solid var(--border);border-radius:14px;padding:14px;background:var(--card);box-shadow:var(--shadow);}
.kpi h3{margin:0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.kpi .val{margin-top:6px;font-size:22px;font-weight:700;}
.toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 14px;}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--bg);border:1px solid var(--border);color:var(--muted);font-size:12px;}
select{appearance:none;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:180px;box-shadow:var(--shadow);}
select:focus{outline:none;border-color:#a7b6cc}
.theme-toggle{margin-left:auto;padding:6px 12px;font-size:12px;border-radius:10px;border:1px solid var(--border);background:var(--card);cursor:pointer;color:var(--text);box-shadow:var(--shadow);}
.legend{font-size:13px;color:var(--muted);margin-bottom:8px;}
iframe{width:100%;height:80vh;border:none;border-radius:12px;background:var(--card);box-shadow:var(--shadow);}

@media(max-width:1200px){.grid-3{grid-template-columns:repeat(2,1fr);}}
@media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr);} .grid-3,.grid-2{grid-template-columns:1fr;}}
@media(max-width:520px){body{padding:16px;} h1{font-size:24px;} .kpi .val{font-size:20px}}
</style>
</head>
<body>
  <h1 style="display:flex;align-items:center;justify-content:space-between;">
    Health Wellness Dashboard
    <button id="themeToggle" class="theme-toggle">ðŸŒ™ Dark Mode</button>
  </h1>
  <div id="loadStatus" class="small">Loading dataâ€¦</div>

  <div class="tabs">
    <button class="tab-button active" onclick="openTab('current')">Current Data</button>
    <button class="tab-button" onclick="openTab('clubInsights')">Club Insights</button>
    <button class="tab-button" onclick="openTab('active')">Active Partners</button>
    <button class="tab-button" onclick="openTab('pending')">Pending Inquiries</button>
    <button class="tab-button" onclick="openTab('changelog')">Changelog</button>
  </div>

  <!-- CURRENT DATA -->
  <div class="tab-content active" id="current">
    <div class="kpis">
      <div class="kpi"><h3>Total Members</h3><div class="val" id="kpiTotal">0</div></div>
      <div class="kpi"><h3>Black Card</h3><div class="val" id="kpiBC">0</div></div>
      <div class="kpi"><h3>10NR</h3><div class="val" id="kpi10NR">0</div></div>
      <div class="kpi"><h3>Unique Promo Codes</h3><div class="val" id="kpiPromo">0</div></div>
    </div>

    <div class="grid-3">
      <div class="card"><div class="legend">Region Breakdown â€” Total Members</div><div id="regionTotalChart"></div></div>
      <div class="card"><div class="legend">Region Breakdown â€” Black Card</div><div id="regionBCChart"></div></div>
      <div class="card"><div class="legend">Region Breakdown â€” 10NR</div><div id="region10NRChart"></div></div>
    </div>

    <div class="grid-2" style="margin-top:18px;">
      <div class="card"><div class="legend">Monthly Impact â€” US</div><div id="impactUS"></div></div>
      <div class="card"><div class="legend">Monthly Impact â€” CAN</div><div id="impactCAN"></div></div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div class="legend">Top 5 Promotions by Region (US vs CAN)</div>
      <div id="promoChart"></div>
    </div>
  </div>

  <!-- CLUB INSIGHTS -->
  <div class="tab-content" id="clubInsights">
    <div class="card">
      <div class="toolbar">
        <label class="pill">Select Club
          <select id="clubSelect"><option value="__ALL__" selected>All Clubs</option></select>
        </label>
        <label class="pill">Select Month
          <select id="monthSelect"><option value="all" selected>All Months</option></select>
        </label>
      </div>

      <div class="kpis">
        <div class="kpi"><h3>Total Members</h3><div class="val" id="ckpiTotal">0</div></div>
        <div class="kpi"><h3>Black Card</h3><div class="val" id="ckpiBC">0</div></div>
        <div class="kpi"><h3>10NR</h3><div class="val" id="ckpi10NR">0</div></div>
        <div class="kpi"><h3>Unique Promo Codes</h3><div class="val" id="ckpiCodes">0</div></div>
      </div>

      <div class="grid-3">
        <div class="card"><div class="legend">Region Split</div><div id="clubRegionDonut"></div></div>
        <div class="card"><div class="legend">Promo Code Usage</div><div id="clubUsage"></div></div>
        <div class="card"><div class="legend">Monthly Trend</div><div id="clubTrend"></div></div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div class="legend">Top 5 Clubs by Promo Usage (US vs CAN)</div>
      <div id="topClubsChart"></div>
    </div>
  </div>

  <!-- ACTIVE & PENDING -->
  <div class="tab-content" id="active">
    <div class="card">
      <div class="legend">Active Partners</div>
      <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSkf0CtRTvB6WLSq7NrnCJ13Yy7TKFehNLU4p_IMj7zz_eTJAxw6-fw-27M9UWNDurEWNOZy3vM6l16/pubhtml?gid=1889691124&single=true"></iframe>
    </div>
  </div>

  <div class="tab-content" id="pending">
    <div class="card">
      <div class="legend">Pending Inquiries</div>
      <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSkf0CtRTvB6WLSq7NrnCJ13Yy7TKFehNLU4p_IMj7zz_eTJAxw6-fw-27M9UWNDurEWNOZy3vM6l16/pubhtml?gid=279243253&single=true"></iframe>
    </div>
  </div>

  <!-- CHANGELOG -->
  <div class="tab-content" id="changelog">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Changelog</h2>
      <ul>
        <li>Filtering "CLEMENSBC","CLEMENSWC","MTPCORPWC","CORPBC","CORP15","CORPFMBC","CORPFM15","CORP10","PFCORP10","PFCORPBC"</li>
        <li>Static Top 5 Clubs (overall US+CAN)</li>
        <li>Filters affect KPIs, Region, Promo Usage & Trend</li>
        
      </ul>
    </div>
  </div>

<script>
/* -------- Tabs & Theme -------- */
function openTab(tab){
  document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
  document.getElementById(tab).classList.add("active");
  document.querySelector(`button[onclick="openTab('${tab}')"]`).classList.add("active");
  // ensure visible tab charts are sized correctly after switching
  requestAnimationFrame(resizeAllCharts);
}
document.getElementById("themeToggle").onclick=()=>{
  document.body.classList.toggle("dark");
  const dark=document.body.classList.contains("dark");
  localStorage.setItem("theme",dark?"dark":"light");
  document.getElementById("themeToggle").textContent=dark?"â˜€ï¸ Light Mode":"ðŸŒ™ Dark Mode";
  rerenderAll(); // re-apply palettes + grid colors
  requestAnimationFrame(resizeAllCharts);
};
window.addEventListener("DOMContentLoaded",()=>{
  if(localStorage.getItem("theme")==="dark"){
    document.body.classList.add("dark");
    document.getElementById("themeToggle").textContent="â˜€ï¸ Light Mode";
  }
  loadData();
});
window.addEventListener("resize", ()=>{
  // debounce a bit
  clearTimeout(window.__rsz);
  window.__rsz=setTimeout(resizeAllCharts,120);
});

/* -------- Utils -------- */
const RAW_CODES=["CLEMENSBC","CLEMENSWC","MTPCORPWC","CORPBC","CORP15","CORPFMBC","CORPFM15","CORP10","PFCORP10","PFCORPBC"];
function codeIncluded(n){return RAW_CODES.some(c=>(n||"").toUpperCase().includes(c));}
function normRegion(v){
  const s=(v||"").toUpperCase().trim();
  if(["CA","CAN","CANADA"].includes(s))return"CAN";
  if(["US","USA","UNITED STATES"].includes(s))return"US";
  return s;
}
function monthKeyFromDate(d){return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");}

// Centralized palette + layout
function palette(){
  const dark=document.body.classList.contains("dark");
  return {
    paper: dark?"#0f172a":"#ffffff",
    plot:  dark?"#0f172a":"#ffffff",
    grid:  dark?"#1f2a3a":"#e5eaf1",
    font:  dark?"#f1f5f9":"#0f172a",
    us:    "#2563eb",
    can:   "#9333ea",
    accent:"#10b981"
  };
}
function getLayout(y,x){
  const p=palette();
  return{
    margin:{t:18,b:48,l:60,r:10},
    paper_bgcolor:p.paper,
    plot_bgcolor:p.plot,
    font:{color:p.font},
    xaxis:{title:x,gridcolor:p.grid,zerolinecolor:p.grid},
    yaxis:{title:y,gridcolor:p.grid,zerolinecolor:p.grid},
    legend:{orientation:"h",y:1.12,x:0}
  };
}
function resizeAllCharts(){
  const ids=[
    "regionTotalChart","regionBCChart","region10NRChart",
    "impactUS","impactCAN","promoChart",
    "clubRegionDonut","clubUsage","clubTrend",
    "topClubsChart"
  ];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el && el.data){ Plotly.Plots.resize(el); }
  });
}

/* -------- Data Load -------- */
let GLOBAL={data:[],filtered:[],months:[]};
async function loadData(){
  const status=document.getElementById("loadStatus");
  try{
    const url="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8iruNQ-H8vQvlNMSNXiUtOoxI1b8lEyL7YMBOifM2os3qyRTdmQ2_1V2oKk4vMlQifynBfxrN-u-F/pub?output=csv";
    const res=await fetch(url);
    const text=await res.text();

    // Simple CSV parse (keeps things fast). If your sheet has quoted commas,
    // consider a tiny CSV parser later.
    const rows=text.trim().split("\n").map(r=>r.split(","));
    const headers=rows[0].map(h=>h.trim().toLowerCase());
    const data=rows.slice(1).map(r=>{
      const o={}; headers.forEach((h,i)=>o[h]=r[i]);
      const d=(o["created date"]||"").trim();
      o.dateParsed=new Date(d.includes("/")?d.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/,"$3-$1-$2"):d);
      return o;
    });

    GLOBAL.data=data;
    GLOBAL.filtered=data.filter(r=>codeIncluded(r["promotion name"]));
    GLOBAL.months=[...new Set(GLOBAL.filtered.map(r=>{
      const d=r.dateParsed;if(isNaN(d))return null;return monthKeyFromDate(d);
    }).filter(Boolean))].sort();

    renderCurrent(GLOBAL.filtered);
    setupClubInsights(GLOBAL.filtered);
    renderTopClubsStatic();

    status.textContent=`âœ… Data loaded: ${GLOBAL.filtered.length} matching rows`;
    status.style.color="var(--accent)";
  }catch(e){
    console.error(e);
    status.textContent="âš ï¸ Could not load data.";
    status.style.color="#ef4444";
  }
}

/* -------- Current Data Charts -------- */
function renderCurrent(data){
  const p=palette();

  // KPIs
  document.getElementById("kpiTotal").textContent=data.length;
  document.getElementById("kpiBC").textContent=data.filter(r=>(r["membership type"]||"").toUpperCase().includes("BLACK")).length;
  document.getElementById("kpi10NR").textContent=data.filter(r=>(r["membership type"]||"").toUpperCase().includes("10NR")).length;
  document.getElementById("kpiPromo").textContent=new Set(data.map(r=>(r["promotion name"]||"").trim()).filter(Boolean)).size;

  // Region splits
  const total={US:0,CAN:0}, bc={US:0,CAN:0}, nr={US:0,CAN:0};
  data.forEach(r=>{
    const reg=normRegion(r["region"]);
    if(!(reg in total)) return;
    total[reg]++;
    const m=(r["membership type"]||"").toUpperCase();
    if(m.includes("BLACK")) bc[reg]++;
    if(m.includes("10NR"))  nr[reg]++;
  });

  Plotly.newPlot("regionTotalChart",
    [{x:Object.keys(total),y:Object.values(total),type:"bar",marker:{color:[p.us,p.can]}}],
    {...getLayout("Members","Region"),height:320},
    {displayModeBar:false,responsive:true});

  Plotly.newPlot("regionBCChart",
    [{x:Object.keys(bc),y:Object.values(bc),type:"bar",marker:{color:[p.us,p.can]}}],
    {...getLayout("Black Card","Region"),height:320},
    {displayModeBar:false,responsive:true});

  Plotly.newPlot("region10NRChart",
    [{x:Object.keys(nr),y:Object.values(nr),type:"bar",marker:{color:[p.us,p.can]}}],
    {...getLayout("10NR","Region"),height:320},
    {displayModeBar:false,responsive:true});

  // Monthly Impact by region
  const mUS={}, mCAN={};
  data.forEach(r=>{
    const d=r.dateParsed; if(isNaN(d)) return;
    const key=monthKeyFromDate(d);
    const reg=normRegion(r["region"]);
    if(reg==="US")  mUS[key]=(mUS[key]||0)+1;
    if(reg==="CAN") mCAN[key]=(mCAN[key]||0)+1;
  });
  const kUS=Object.keys(mUS).sort(), kCAN=Object.keys(mCAN).sort();

  Plotly.newPlot("impactUS",
    [{x:kUS,y:kUS.map(k=>mUS[k]),type:"bar",marker:{color:p.us}}],
    {...getLayout("US Signups","Month"),height:320},
    {displayModeBar:false,responsive:true});

  Plotly.newPlot("impactCAN",
    [{x:kCAN,y:kCAN.map(k=>mCAN[k]),type:"bar",marker:{color:p.can}}],
    {...getLayout("CAN Signups","Month"),height:320},
    {displayModeBar:false,responsive:true});

  // Top 5 promotions by region (horizontal)
  const byReg={US:{},CAN:{}}; 
  data.forEach(r=>{
    const pnm=(r["promotion name"]||"").trim(); if(!pnm) return;
    const reg=normRegion(r["region"]); if(!(reg in byReg)) return;
    byReg[reg][pnm]=(byReg[reg][pnm]||0)+1;
  });
  const allPromos=new Set([...Object.keys(byReg.US),...Object.keys(byReg.CAN)]);
  const totals={}; allPromos.forEach(pn=>totals[pn]=(byReg.US[pn]||0)+(byReg.CAN[pn]||0));
  const top=Object.entries(totals).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([pn])=>pn);

  if(top.length===0){
    document.getElementById("promoChart").innerHTML="<p style='text-align:center;color:var(--muted);margin:14px 0;'>No promotion data found.</p>";
  }else{
    Plotly.newPlot("promoChart",
      [
        {name:"US",  x:top.map(pn=>byReg.US[pn]  ||0), y:top, type:"bar", orientation:"h", marker:{color:p.us}},
        {name:"CAN", x:top.map(pn=>byReg.CAN[pn] ||0), y:top, type:"bar", orientation:"h", marker:{color:p.can}}
      ],
      {...getLayout("Usage","Promo Code"),margin:{t:20,l:150,b:50,r:10},barmode:"group",xaxis:{title:"Usage"},height:360},
      {displayModeBar:false,responsive:true}
    );
  }
}

/* -------- Club Insights (filters affect these) -------- */
function setupClubInsights(data){
  const cs=document.getElementById("clubSelect"), ms=document.getElementById("monthSelect");
  [...new Set(data.map(r=>(r["club name"]||"").trim()).filter(Boolean))].sort()
    .forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;cs.appendChild(o);});
  GLOBAL.months.forEach(m=>{
    const [y,mm]=m.split("-"); const d=new Date(y,mm-1);
    const o=document.createElement("option"); o.value=m; o.textContent=d.toLocaleString("default",{month:"long",year:"numeric"});
    ms.appendChild(o);
  });
  cs.onchange=ms.onchange=()=>renderClubInsights();
  renderClubInsights();
}

function renderClubInsights(){
  const p=palette();
  const c=document.getElementById("clubSelect").value;
  const m=document.getElementById("monthSelect").value;
  let rows=[...GLOBAL.filtered];
  if(c!=="__ALL__") rows=rows.filter(r=>(r["club name"]||"").trim()===c);
  if(m!=="all") rows=rows.filter(r=>{
    const d=r.dateParsed; if(isNaN(d)) return false;
    return monthKeyFromDate(d)===m;
  });

  // KPIs
  document.getElementById("ckpiTotal").textContent=rows.length;
  document.getElementById("ckpiBC").textContent=rows.filter(r=>(r["membership type"]||"").toUpperCase().includes("BLACK")).length;
  document.getElementById("ckpi10NR").textContent=rows.filter(r=>(r["membership type"]||"").toUpperCase().includes("10NR")).length;
  document.getElementById("ckpiCodes").textContent=new Set(rows.map(r=>(r["promotion name"]||"").trim()).filter(Boolean)).size;

  // Region donut
  const sum={US:0,CAN:0};
  rows.forEach(r=>{const reg=normRegion(r["region"]); if(sum[reg]!=null) sum[reg]++;});
  Plotly.newPlot("clubRegionDonut",
    [{labels:["US","CAN"],values:[sum.US,sum.CAN],type:"pie",hole:.55,
      marker:{colors:[p.us,p.can]},textinfo:"label+percent",hovertemplate:"%{label}: %{value}<extra></extra>"}],
    {paper_bgcolor:p.paper,plot_bgcolor:p.plot,showlegend:false},
    {displayModeBar:false,responsive:true});

  // Promo usage (top 5 in the scoped rows)
  const pc={}; rows.forEach(r=>{const pn=(r["promotion name"]||"").trim(); if(pn) pc[pn]=(pc[pn]||0)+1;});
  const sorted=Object.entries(pc).sort((a,b)=>b[1]-a[1]).slice(0,5);
  Plotly.newPlot("clubUsage",
    [{x:sorted.map(s=>s[1]),y:sorted.map(s=>s[0]),type:"bar",orientation:"h",marker:{color:p.accent}}],
    {...getLayout("Usage","Promo Code"),margin:{t:10,l:140,b:50,r:10}},
    {displayModeBar:false,responsive:true});

  // Monthly trend
  const monthly={};
  rows.forEach(r=>{
    const d=r.dateParsed; if(isNaN(d)) return;
    const key=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    monthly[key]=(monthly[key]||0)+1;
  });
  const keys=Object.keys(monthly).sort();
  const labels=keys.map(k=>{
    const [yy,mm]=k.split("-"); return new Date(yy,mm-1).toLocaleString("default",{month:"short",year:"numeric"});
  });
  Plotly.newPlot("clubTrend",
    [{x:labels,y:keys.map(k=>monthly[k]),type:"scatter",mode:"lines+markers",line:{width:3,color:p.us},marker:{size:6}}],
    getLayout("Signups","Month"),
    {displayModeBar:false,responsive:true});
}

/* -------- Static Top Clubs (overall, not filtered) -------- */
function renderTopClubsStatic() {
  const p = palette();
  const rows = GLOBAL.filtered;
  const clubsUS = {}, clubsCAN = {};
  rows.forEach(r => {
    const club = (r["club name"] || "").trim();
    const promo = (r["promotion name"] || "").trim();
    const reg = normRegion(r["region"]);
    if (!club || !promo) return;
    if (reg === "US") clubsUS[club] = clubsUS[club] || { count: 0, promo: promo };
    if (reg === "CAN") clubsCAN[club] = clubsCAN[club] || { count: 0, promo: promo };
    if (reg === "US") clubsUS[club].count++;
    if (reg === "CAN") clubsCAN[club].count++;
  });

  const all = new Set([...Object.keys(clubsUS), ...Object.keys(clubsCAN)]);
  const totals = {};
  all.forEach(c => totals[c] = (clubsUS[c]?.count || 0) + (clubsCAN[c]?.count || 0));
  const top = Object.entries(totals).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([c]) => c);

  // Combine club + promo for display
  const displayNames = top.map(c => {
    const promo = clubsUS[c]?.promo || clubsCAN[c]?.promo || "";
    return promo ? `${c} (${promo})` : c;
  });

  Plotly.newPlot("topClubsChart",
    [
      {
        name: "US",
        x: top.map(c => clubsUS[c]?.count || 0),
        y: displayNames,
        type: "bar",
        orientation: "h",
        marker: { color: p.us },
        hovertemplate: "%{y}<br>US Usage: %{x}<extra></extra>"
      },
      {
        name: "CAN",
        x: top.map(c => clubsCAN[c]?.count || 0),
        y: displayNames,
        type: "bar",
        orientation: "h",
        marker: { color: p.can },
        hovertemplate: "%{y}<br>CAN Usage: %{x}<extra></extra>"
      }
    ],
    {
      ...getLayout("Usage", "Club (Promo Code)"),
      margin: { t: 20, l: 300, b: 50, r: 20 },
      barmode: "group",
      xaxis: { title: "Usage" },
      yaxis: { automargin: true }
    },
    { displayModeBar: false, responsive: true }
  );
}

/* -------- Theme re-render -------- */
function rerenderAll(){
  // re-render using current filtered state
  renderCurrent(GLOBAL.filtered);
  renderClubInsights();
  renderTopClubsStatic();
}
</script>
</body>
</html>

